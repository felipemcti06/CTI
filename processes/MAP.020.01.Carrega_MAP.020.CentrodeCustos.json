{
	"@type":"Process",
	"Name":"MAP.020.01.Carrega_MAP.020.CentrodeCustos",
	"UID":"1746471137000",
	"HasSecurityAccess":false,
	"Code":"#region Prolog\r\n\r\n# ===============================================================================================================\r\n#GENERALCOMMENT             Descrição:  Carrega dados CSV para o MAP.020.CentrodeCustos\r\n#GENERALCOMMENT             Responsável: Vitor Ribeiro\r\n#GENERALCOMMENT             Data Criação:  Abril/2025\r\n#\r\n#LASTCHANGE                 Alterações:\r\n#LASTCHANGE                 Responsavel Alterações:\r\n# ===============================================================================================================\r\n\r\n# ===============================================================================================================\r\n#PROLOGCOMMENT               Descrição:            Define arquivo fonte \r\n# ===============================================================================================================\r\n\r\n# =================================================================================\r\n# Variáveis do padrão CTI que devem ser alteradas\r\n# =================================================================================\r\n\r\n\r\n# Informações do cubo de Destino\r\n# ========================================\r\ncCuboDestino\t\t= 'MAP.020.CentrodeCustos';\r\n\r\n\r\n\r\n# =================================================================================\r\n# Variáveis do padrão CTI não devem ser alteradas\r\n# =================================================================================\r\n\r\n# Recupera o usuário que executou o processo\r\n# ========================================\r\ncUsuario = IF( DimIx( '}Clients' , TM1User() ) = 0, 'Executed by Chore' , ATTRS('}Clients', TM1User(), '}TM1_DefaultDisplayValue') );\r\n  \r\n\r\n  \r\n# Variáveis de controle do processo\r\n# ========================================\r\ncCuboParametro\t\t\t= 'SYS.150.Controle_Cargas';\r\ncCuboRejeitado \t\t\t= 'SYS.300.Reject_Cube' ;\r\ncCuboPropriedade\t\t\t= '}CubeProperties';\r\ncHorarioInicio\t\t\t= Now();\r\ncProcesso\t\t\t= GetProcessName();\r\ncMensagemRegistro\t \t= '';\r\ncMensagemProcesso \t\t= '';\r\ncExisteRegistroRejeitado \t\t= 0;\r\ncExisteCabecalhoRejeitado \t\t= 0;\r\ncQtdRegistroRejeitado\t\t= 0;\r\ncTipoErro\t\t\t\t= 0;\r\ncContadorRegistro \t\t\t= 0;\r\n\r\n\r\n\r\n# Variáveis do cubo de controle\r\n# ========================================\r\ncCaminhoArquivoFonte \t\t= CellGetS( cCuboParametro , cProcesso , 'Caminho do Arquivo Fonte' );\r\ncCaminhoArquivoRejeitado  \t\t= CellGetS( cCuboParametro , cProcesso , 'Caminho do Arquivo de Rejeitado' );\r\ncUtilizarDebug\t\t \t= CellGetS( cCuboParametro , cProcesso , 'Debug (S/N)' );\r\ncGravarLogAlteracao\t\t= CellGetS( cCuboParametro , cProcesso , 'Gerar Log de Alteração (S/N)' );\r\n\r\n\r\n\r\n# Tratamento para os campos vindos do cubo de controle que recebem (S/N)\r\n# ========================================\r\ncUtilizarDebug\t\t \t= IF( cUtilizarDebug @= 'S' , 'S' , 'N' );\r\ncGravarLogAlteracao\t\t= IF( cGravarLogAlteracao @= 'S' , 'S' , 'N' );\r\n\r\n\r\n\r\n\r\n# =================================================================================\r\n# Define variáveis locais de arquivo\r\n# =================================================================================\r\ncDelimitadorArquivo \t\t= ';';\r\ncSeparadorMilhar\t\t\t= '.';\r\ncSeparadorDecimal\t\t\t= ',';\r\n\r\nDataSourceASCIIDelimiter \t\t= cDelimitadorArquivo;\r\nDataSourceASCIIThousandSeparator \t= cSeparadorMilhar;\r\nDataSourceASCIIDecimalSeparator \t= cSeparadorDecimal;\r\nDataSourceQuoteCharacter \t\t= '';\r\n\r\n\r\n# =================================================================================\r\n# Define o Log inicial da carga como falha\r\n# Registra esse log logo no inicio para garantir que tenha algum log de falha registrado\r\n# Caso o processo não consiga chegar no próximo registro de log por alguma falha inesperada\r\n# =================================================================================\r\ncMensagemProcesso\t= 'Processo com falha, contate o administrador para verificar os logs de erro do sistema' ;\r\ns01\t\t\t= TimSt( cHorarioInicio , '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ns02 \t\t\t= cUsuario ;\r\ns03 \t\t\t= cMensagemProcesso ;\r\ns04 \t\t\t= '0' ;\r\ns05 \t\t\t= TimSt( cHorarioInicio - Now, '\\Y-\\m-\\d \\hh\\im\\ss' );\r\n\r\nCellPutS( s01 , cCuboParametro, cProcesso, 'DataHora Inicio' );\r\nCellPutS( s01 , cCuboParametro, cProcesso, 'DataHora Fim' );\r\nCellPutS( s02 , cCuboParametro, cProcesso, 'Usuário' );\r\nCellPutS( s03 , cCuboParametro, cProcesso, 'Mensagem de Log' );\r\nCellPutS( s04 , cCuboParametro, cProcesso, 'Registros Processados' );\r\nCellPutS( s05 , cCuboParametro, cProcesso, 'Tempo de Execução' );\r\n\r\n\r\n\r\n\r\n# =================================================================================\r\n# Validação do arquivo de origem e pasta\r\n# Teste 1 - Se o caminho do arquivo fonte foi preenchido no cubo de controle\r\n# Teste 2 - Se o caminho do arquivo rejeitado foi preenchido no cubo de controle\r\n# Teste 3 - Se o diretório do arquivo fonte existir\r\n# Teste 4 - Se o diretório do arquivo de rejeitado/debug existir\r\n# Teste 5 - Se o arquivo fonte existe na pasta informada\r\n# =================================================================================\r\n\r\n\r\n# # Define o nome dos arquivos\r\n# # ======================================================\r\n# cSufixoRejeitado\t\t= IF( cUtilizarDebug @= 'S' , 'Debug' , 'Reject' );\r\n\r\n# cNomeArquivoFonte\t=  pFile;\r\n\r\n\r\n# # Monta o caminho completo \r\n# # ======================================================\r\n# cNomeArquivoFonteCompleto \t= cCaminhoArquivoFonte | cNomeArquivoFonte;\r\n\r\n\r\n\r\n#  # Aborta o processo se o arquivo fonte não existir na pasta de origem\r\n#  # ======================================================\r\n#  IF( FileExists( cNomeArquivoFonteCompleto ) = 0 );\r\n#     cTipoErro = 1;\r\n#     cMensagemProcesso = 'O arquivo   \"' | cNomeArquivoFonte | '\"   não existe no diretorio:   \"' | cCaminhoArquivoFonte | '\"' ;\r\n#     DataSourceType = 'NULL';\r\n#     ItemReject( cMensagemProcesso );\r\n#  ENDIF;\r\n\r\n\r\n# # Define o arquivo fonte como a nova fonte de dados deste processo\r\n# # ======================================================\r\n# DatasourceNameForServer\t\t= cNomeArquivoFonteCompleto ;\r\n# DatasourceNameForClient\t\t= cNomeArquivoFonteCompleto ;\r\n\r\n# CellPutS( pFile, cCuboParametro , cProcesso , 'Prefixo do Arquivo' );\r\n\r\n# =================================================================================\r\n# Limpa dados do cubo de destino\r\n# =================================================================================\r\n #CubeClearData ( cCuboDestino );\r\n\r\n#Region Limpeza Cubo Rejeitados\r\n# =================================================================================\r\n#\r\n# Definição View de Limpeza do Cudo de Rejeitados\r\n#\r\n# =================================================================================\r\n\r\n# Define nome da view e subset de limpeza\r\n# ======================================================\r\ncViewRejeitado\t= 'processo.' | cProcesso | '.Rejeitados.Limpeza' | '.' | TimSt( cHorarioInicio, '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ncSubsetRejeitado\t= cViewRejeitado;\r\n\r\n\r\n\r\n# Cria a view que será utilizada para a limpeza\r\n# ======================================================\r\nViewCreate( cCuboRejeitado , cViewRejeitado , 1 );\r\n\r\n# Cria os subsets que serão utilizados para filtrar a view de limpeza\r\n# ======================================================\r\n\r\ncDimensao\t= '}Clients';\r\ncElemento\t= cUsuario;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetRejeitado , 1 );  \r\n  ViewSubsetAssign( cCuboRejeitado , cViewRejeitado, cDimensao , cSubsetRejeitado );  \r\n  SubsetElementInsert( cDimensao, cSubsetRejeitado, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n\r\ncDimensao\t= '}Processes';\r\ncElemento\t= cProcesso;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetRejeitado , 1 );  \r\n  ViewSubsetAssign( cCuboRejeitado , cViewRejeitado, cDimensao , cSubsetRejeitado );  \r\n  SubsetElementInsert( cDimensao, cSubsetRejeitado, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n# Configuração da View\r\n# ======================================================\r\nViewExtractSkipCalcsSet( cCuboRejeitado, cViewRejeitado, 1 );\r\nViewExtractSkipZeroesSet( cCuboRejeitado, cViewRejeitado, 1 );\r\nViewExtractSkipRuleValuesSet( cCuboRejeitado, cViewRejeitado, 1 );\r\n\r\n# Apaga os valores da View criada\r\n# ======================================================\r\nViewZeroOut( cCuboRejeitado, cViewRejeitado );\r\n#EndRegion\r\n\r\n\r\n\r\n#endregion\r\n#region Metadata\r\n\r\n# ===============================================================================================================\r\n#METADATACOMMENT        Descrição:  Adiciona elementos na dimensão principal do cubo mapa\r\n# ===============================================================================================================\r\n\r\n\r\n# =================================================================================\r\n# Atualiza dimensão do Mapa\r\n# =================================================================================\r\nsElm = vElement;\r\nsDim = 'MAP.D.CentrodeCustos';\r\n\r\nIf( sElm @<> '' & DimIx( sDim, sElm ) = 0 );\r\n    DimensionElementInsert( sDim, '', sElm,  'n' );\r\nEndIf;\r\n\r\n#endregion\r\n#region Data\r\n\r\n# ===============================================================================================================\r\n#DATACOMMENT        Descrição:  Grava dados no cubo\r\n# ===============================================================================================================\r\n\r\n# ===================================================================================\r\n# Gera contador para o arquivo de debug ou registros rejeitados o e quantid. total de registros processados\r\n# ===================================================================================\r\ncContadorRegistro = cContadorRegistro + 1;\r\nsContadorRegistro = NumberToString( cContadorRegistro );\r\n\r\n\r\n# ===================================================================================\r\n# Retira os espaços em branco\r\n# ===================================================================================\r\nvNome = Trim(vNome);\r\nvNome_Depara = Trim(vNome_Depara);\r\nvUnidade = Trim(vUnidade);\r\nvUnidade_Depara = Trim(vUnidade_Depara);\r\nvDepara = Trim(vDepara);\r\nvCarteira = Trim(vCarteira);\r\nvCarteira_Cross = Trim(vCarteira_Cross);\r\nvDRE = Trim(vDRE);\r\n\r\n\r\n\r\n# ===================================================================================\r\n# Pula o Registro se todas as colunas estiverem vazias\r\n# ===================================================================================\r\nIF( '' @= vNome\r\n  & '' @= vNome_Depara\r\n  & '' @= vUnidade\r\n  & '' @= vUnidade_Depara\r\n  & '' @= vDepara\r\n  & '' @= vCarteira\r\n  & '' @= vCarteira_Cross\r\n  & '' @= vDRE\r\n  );\r\n  ItemSkip;\r\nEndIf;\r\n\r\n\r\n# ===================================================================================\r\n# Marca o registro para rejeitar \r\n# Caso a variável for obrigatória e estiver em branco\r\n# ===================================================================================\r\nsElm\t= vNome ;\r\nsCol\t= 'Nome_do_centro_custo';\r\n\r\nIf( cExisteRegistroRejeitado = 0 );\r\n   If( sElm @= '' );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    está em branco e é obrigatório ter algum valor';\r\n      cExisteRegistroRejeitado = 1;\r\n   EndIf;\r\nEndIf;\r\n\r\n\r\n# ===================================================================================\r\n# Marca o registro para rejeitar \r\n# Caso a variável for obrigatória e estiver em branco\r\n# ===================================================================================\r\nsElm\t= vNome_Depara ;\r\nsCol\t= 'Nome_Depara_centro_custo';\r\n\r\nIf( cExisteRegistroRejeitado = 0 );\r\n   If( sElm @= '' );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    está em branco e é obrigatório ter algum valor';\r\n      cExisteRegistroRejeitado = 1;\r\n   EndIf;\r\nEndIf;\r\n\r\n\r\n# ===================================================================================\r\n# Marca o registro para rejeitar \r\n# Caso a variável for obrigatória e estiver em branco\r\n# ===================================================================================\r\nsElm\t= vDepara ;\r\nsCol\t= 'Cod Depara';\r\n\r\nIf( cExisteRegistroRejeitado = 0 );\r\n   If( sElm @= '' );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    está em branco e é obrigatório ter algum valor';\r\n      cExisteRegistroRejeitado = 1;\r\n   EndIf;\r\nEndIf;\r\n\r\n\r\n# ===================================================================================\r\n# Marca o registro para rejeitar \r\n# Caso a variável for obrigatória e estiver em branco\r\n# ===================================================================================\r\nsElm\t= vUnidade_Depara ;\r\nsCol\t= 'Unidade_Depara_centro_custo';\r\n\r\nIf( cExisteRegistroRejeitado = 0 );\r\n   If( sElm @= '' );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    está em branco e é obrigatório ter algum valor';\r\n      cExisteRegistroRejeitado = 1;\r\n   EndIf;\r\nEndIf;\r\n\r\n# # ===================================================================================\r\n# # Marca o registro para rejeitar \r\n# # Verifica se o registro está duplicado no arquivo\r\n# # ===================================================================================\r\n# If( cExisteRegistroRejeitado = 0 );\r\n#   sDuplic = CellGetS( cCuboDestino, vElement, 'Data Atualização' );\r\n#    If ( sDuplic @<> '' );\r\n#       cExisteRegistroRejeitado = 1;\r\n#       cMensagemRegistro = 'Registro duplicado no arquivo fonte.';\r\n#    EndIf;\r\n# EndIf;\r\n\r\n\r\n\r\n# ===================================================================================\r\n# DEBUG ou REJEIÇÃO\r\n# Registra em arquivo os registros\r\n# ===================================================================================\r\nIf( cExisteRegistroRejeitado = 1  %  cUtilizarDebug @= 'S' );\r\n# Escreve o registro no arquivo de debug ou rejeitados\r\n# =================================================================================\r\n  cQtdRegistroRejeitado = cQtdRegistroRejeitado + 1;\r\n  if(cQtdRegistroRejeitado<1000);  \r\n    sLine = 'Line' | Fill( '0' , 3 - Long(NumberToString( cQtdRegistroRejeitado ))) | NumberToString( cQtdRegistroRejeitado ) ;\r\n    CellPutS( sContadorRegistro, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Num. Registro' );\r\n    CellPutS( cMensagemRegistro, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Mensagem de Erro' );\r\n    CellPutS( vElement, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col01' );\r\n    CellPutS( vNome, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col02' );\r\n    CellPutS( vNome_Depara, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col03' );\r\n    CellPutS( vUnidade, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col04' );\r\n    CellPutS( vUnidade_Depara, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col05' );\r\n    CellPutS( vDepara, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col06' );\r\n    CellPutS( vCarteira, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col07' );\r\n    CellPutS( vCarteira_Cross, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col08' );\r\n    CellPutS( vDRE, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col09' );\r\n  endIF;  \r\n\r\n  # Limpa as variaveis e pula o registro\r\n  # ============================\r\n  IF( cExisteRegistroRejeitado = 1 );\r\n     cTipoErro = 2;\r\n     cExisteRegistroRejeitado = 0;\r\n     cMensagemRegistro = '';\r\n     cMensagemProcesso = ' Processo concluido com registros rejeitados, verificar o cubo:    ' | cCuboRejeitado;\r\n     ItemSkip;\r\n  EndIf;\r\nEndIf;\r\n\r\n\r\n\r\n# ===================================================================================\r\n# Grava os dados no cubo\r\n# === ================================================================================\r\ns01 = vNome ;\r\ns02 = vNome_Depara ;\r\ns03 = vUnidade ;\r\ns04 = vUnidade_Depara ;\r\ns05 = vDepara ;\r\ns06 = vCarteira ;\r\ns07 = vCarteira_Cross ;\r\ns08 = vDRE ;\r\n\r\nCellPutS ( s01, cCuboDestino, vElement, 'Nome_do_centro_custo' );\r\nCellPutS ( s02, cCuboDestino, vElement, 'Nome_Depara_centro_custo' );\r\nCellPutS ( s03, cCuboDestino, vElement, 'Unidade_centro_custo' );\r\nCellPutS ( s04, cCuboDestino, vElement, 'Unidade_Depara_centro_custo' );\r\nCellPutS ( s05, cCuboDestino, vElement, 'Cod_Depara' );\r\nCellPutS ( s06, cCuboDestino, vElement, 'Carteira' );\r\nCellPutS ( s07, cCuboDestino, vElement, 'Carteira_Cross' );\r\nCellPutS ( TimSt( cHorarioInicio , '\\Y-\\m-\\d \\hh\\im\\ss' ), cCuboDestino, vElement, 'Data Atualização' );\r\n\r\n#endregion\r\n#region Epilog\r\n\r\n# ===============================================================================================================\r\n#EPILOGCOMMENT        Descrição:  Habilita log do cubo de destino, realiza CubeSaveData e registra log de status do processo.\r\n# ===============================================================================================================\r\n\r\n# =================================================================================\r\n# Habilita o Log e salva dados no cubo\r\n# =================================================================================\r\n# CellPutS ( 'YES', cCuboPropriedade, cCuboDestino, 'LOGGING' );\r\n# CubeSaveData ( cCuboDestino );\r\n\r\n\r\n# =================================================================================\r\n# Registra o Log de Erro ou Sucesso no Cubo de Controle\r\n# =================================================================================\r\nIf( cTipoErro = 0 );\r\n   cMensagemProcesso  = ' Processo concluído com sucesso';\r\nEndIf;\r\n\r\n\r\ns01\t= TimSt( cHorarioInicio , '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ns02 \t= cUsuario ;\r\ns03 \t= cMensagemProcesso ;\r\ns04 \t= sContadorRegistro  ;\r\ns05 \t= TimSt( Now - cHorarioInicio, ' \\h:\\i:\\s') ;\r\n\r\nCellPutS( s01 , cCuboParametro, cProcesso, 'DataHora Fim' );\r\nCellPutS( s02 , cCuboParametro, cProcesso, 'Usuário' );\r\nCellPutS( s03 , cCuboParametro, cProcesso, 'Mensagem de Log' );\r\nCellPutS( s04 , cCuboParametro, cProcesso, 'Registros Processados' );\r\nCellPutS( s05 , cCuboParametro, cProcesso, 'Tempo de Execução' );\r\n\r\n\r\nIf( cTipoErro = 2 );\r\n  ItemReject( cMensagemProcesso );\r\nEndIf;\r\n\r\n\r\n#endregion",
	"DataSource":
	{
		"Type":"ODBC",
		"dataSourceNameForServer":"GoogleBigQuery",
		"dataSourceNameForClient":"GoogleBigQuery",
		"userName":"admin",
		"password":"F18yWohsAAQ3s",
		"query":"select a.centro_custo,a.descricao, c.descricao as Nome_Depara,a.unidade,c.unidade as Unidade_Depara,b.centro_custo_atual,a.carteira,a.carteira_cross\r\nfrom data-plataform-prd.oracle.centro_custo_oracle a \r\ninner Join data-plataform-prd.oracle.de_para_centro_custo_oracle b ON a.centro_custo = b.centro_custo_antigo\r\ninner Join data-plataform-prd.oracle.centro_custo_oracle c ON c.centro_custo = b.centro_custo_atual"
	},
	"Parameters":[],
	"Variables":
	[
		{
			"Name":"vElement",
			"Type":"String",
			"Position":1,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vNome",
			"Type":"String",
			"Position":2,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vNome_Depara",
			"Type":"String",
			"Position":3,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vUnidade",
			"Type":"String",
			"Position":4,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vUnidade_Depara",
			"Type":"String",
			"Position":5,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vDepara",
			"Type":"String",
			"Position":6,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vCarteira",
			"Type":"String",
			"Position":7,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vCarteira_Cross",
			"Type":"String",
			"Position":8,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vDRE",
			"Type":"String",
			"Position":9,
			"StartByte":0,
			"EndByte":0
		}
	],
	"UID": "1746471137000",
	"UIData": "_ParameterConstraints=e30=\f",
	"VariablesUIData": [
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"IgnoredInputVarName=v10\fVarType=32\fColType=1165\f",
		"IgnoredInputVarName=v11\fVarType=32\fColType=1165\f"
	]
}