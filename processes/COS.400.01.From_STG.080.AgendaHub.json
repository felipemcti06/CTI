{
	"@type":"Process",
	"Name":"COS.400.01.From_STG.080.AgendaHub",
	"UID":"1748890713000",
	"HasSecurityAccess":false,
	"Code":"#region Prolog\r\n\r\n# ===============================================================================================================\r\n#GENERALCOMMENT             Descrição:         Carrega dados do cubo STG.080 para o cubo COS.400\r\n#GENERALCOMMENT             Responsável:   \tVitor Ribeiro\r\n#GENERALCOMMENT             Data Criação:    Maio/2025\r\n#\r\n#LASTCHANGE                 Alterações:\r\n#LASTCHANGE                 Responsavel Alterações:\r\n# ===============================================================================================================\r\n\r\n# ===============================================================================================================\r\n#PROLOGCOMMENT               Descrição:            \tCria view de leitura utlizando como filtro Parametros de Ano e Mês.\r\n# ===============================================================================================================\r\n\r\n# =================================================================================\r\n# Variáveis do padrão CTI que devem ser alteradas\r\n# =================================================================================\r\n\r\n#Region  Variaveis Gegais\r\n# =================================================================================\r\n\r\n# Informações dos cubos de Origem e Destino\r\n# ========================================\r\ncCuboOrigem\t\t= 'STG.080.AgendaHub';\r\ncCuboDestino\t\t= 'COS.400.CustoHD';\r\n\r\n\r\n\r\n# =================================================================================\r\n# Variáveis do padrão CTI não devem ser alteradas\r\n# =================================================================================\r\n\r\n# Recupera o usuário que executou o processo\r\n# ========================================\r\ncUsuario = IF( DimIx( '}Clients' , TM1User() ) = 0, 'Executed by Chore' , ATTRS('}Clients', TM1User(), '}TM1_DefaultDisplayValue') );\r\n  \r\n\r\n  \r\n# Variáveis de controle do processo\r\n# ========================================\r\ncCuboParametro\t\t\t= 'SYS.150.Controle_Cargas';\r\ncCuboRejeitado \t\t\t= 'SYS.300.Reject_Cube' ;\r\ncHorarioInicio\t\t\t= Now();\r\ncProcesso\t\t\t= GetProcessName();\r\ncMensagemRegistro\t \t= '';\r\ncMensagemProcesso \t\t= '';\r\ncExisteRegistroRejeitado \t\t= 0;\r\ncExisteCabecalhoRejeitado \t\t= 0;\r\ncQtdRegistroRejeitado\t\t= 0;\r\ncTipoErro\t\t\t\t= 0;\r\ncContadorRegistro \t\t\t= 0;\r\n\r\n\r\n\r\n# Variáveis do cubo de controle\r\n# ========================================\r\ncUtilizarDebug\t\t \t= CellGetS( cCuboParametro , cProcesso , 'Debug (S/N)' );\r\ncUtilizarDebug\t\t \t= IF( cUtilizarDebug @= 'S' , 'S' , 'N' );\r\n\r\n# =================================================================================\r\n#EndRegion\r\n\r\n#Region SYS.150\r\n\r\n# =================================================================================\r\n# Define o Log inicial da carga como falha\r\n# Registra esse log logo no inicio para garantir que tenha algum log de falha registrado\r\n# Caso o processo não consiga chegar no próximo registro de log por alguma falha inesperada\r\n# =================================================================================\r\ncMensagemProcesso\t= 'Processo com falha, contate o administrador para verificar os logs de erro do sistema' ;\r\ns01\t\t\t= TimSt( cHorarioInicio , '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ns02 \t\t\t= cUsuario ;\r\ns03 \t\t\t= cMensagemProcesso ;\r\ns04 \t\t\t= '0' ;\r\ns05 \t\t\t= TimSt( cHorarioInicio - Now, '\\Y-\\m-\\d \\hh\\im\\ss' );\r\n\r\nCellPutS( s01 , cCuboParametro, cProcesso, 'DataHora Inicio' );\r\nCellPutS( s01 , cCuboParametro, cProcesso, 'DataHora Fim' );\r\nCellPutS( s02 , cCuboParametro, cProcesso, 'Usuário' );\r\nCellPutS( s03 , cCuboParametro, cProcesso, 'Mensagem de Log' );\r\nCellPutS( s04 , cCuboParametro, cProcesso, 'Registros Processados' );\r\nCellPutS( s05 , cCuboParametro, cProcesso, 'Tempo de Execução' );\r\n\r\n# =================================================================================\r\n#EndRegion\r\n\r\n#Region Validação dos parâmetros\r\n# =================================================================================\r\n# Teste 1 - O parâmetro só será validado caso exista uma dimensão atrelada\r\n# Teste 2 - Parâmetro não informado\r\n# Teste 3 - Se o parâmetro informado existe na dimensão de validação\r\n# =================================================================================\r\n\r\n# Força 2 digitos no parâmetro pMes\r\n# ========================================\r\npMes = FILL( '0', 2 - LONG( Trim( pMes ) ) ) | Trim( pMes );\r\n\r\n\r\n\r\n# Parâmetro 1\r\n# =========================\r\nsDim = 'ALL.D.ANO';\r\nsElm = pAno;\r\n\r\nIf( Trim( sDim ) @<> '' );\r\n  If( Trim( sElm ) @= '' );\r\n    cTipoErro = 1;\r\n    DataSourceType = 'NULL';\r\n    cMensagemProcesso = 'O parâmetro    [ ' | sDim | ' ]    não foi Informado' ;\r\n    ItemReject( cMensagemProcesso );\r\n  ElseIf( DimIx( sDim , sElm ) = 0 );\r\n    cTipoErro = 1;\r\n    DataSourceType = 'NULL';\r\n    cMensagemProcesso = 'O elemento    [ ' | sElm | ' ]    não existe na dimensão    [ ' | sDim | ' ]';\r\n    ItemReject( cMensagemProcesso );\r\n  EndIf;\r\nEndIf;\r\n\r\n\r\n\r\n# Parâmetro 2\r\n# =========================\r\nsDim = 'ALL.D.Mes';\r\nsElm = pMes;\r\n\r\nIf( Trim( sDim ) @<> '' );\r\n  If( Trim( sElm ) @= '' );\r\n    cTipoErro = 1;\r\n    DataSourceType = 'NULL';\r\n    cMensagemProcesso = 'O parâmetro    [ ' | sDim | ' ]    não foi Informado' ;\r\n    ItemReject( cMensagemProcesso );\r\n  ElseIf( DimIx( sDim , sElm ) = 0 );\r\n    cTipoErro = 1;\r\n    DataSourceType = 'NULL';\r\n    cMensagemProcesso = 'O elemento    [ ' | sElm | ' ]    não existe na dimensão    [ ' | sDim | ' ]';\r\n    ItemReject( cMensagemProcesso );\r\n  EndIf;\r\nEndIf;\r\n\r\n\r\n#EndRegion\r\n\r\n#Region View de Limpeza do Cudo de Destino\r\n# =================================================================================\r\n\r\ncSuprimirConsolidado\t= 'S';\r\ncSuprimirZero\t\t= 'S'; \r\ncSuprimirCamposCalculados\t= 'S';\r\ncViewTemporaria\t \t= 'S';\r\nnViewTemporaria\t\t= If( cViewTemporaria @= 'S', 1, 0);\r\n\r\n\r\n# Define nome da view e subset de limpeza\r\n# ======================================================\r\ncViewDestino\t= 'processo.' | cProcesso | '.' | 'Limpeza' | '.' | TimSt( cHorarioInicio, '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ncSubsetDestino\t= cViewDestino;\r\n\r\n\r\n\r\n# Cria a view que será utilizada para a limpeza\r\n# ======================================================\r\nViewCreate( cCuboDestino , cViewDestino , nViewTemporaria );\r\n\r\n\r\n\r\n# Cria os subsets que serão utilizados para filtrar a view de limpeza\r\n# ======================================================\r\n\r\ncDimensao\t= 'ALL.D.Ano';\r\ncElemento\t= pAno;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetDestino , nViewTemporaria );  \r\n  ViewSubsetAssign( cCuboDestino , cViewDestino, cDimensao , cSubsetDestino );  \r\n  SubsetElementInsert( cDimensao, cSubsetDestino, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n\r\ncDimensao\t= 'ALL.D.Mes';\r\ncElemento\t= pMes;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetDestino , nViewTemporaria );  \r\n  ViewSubsetAssign( cCuboDestino , cViewDestino, cDimensao , cSubsetDestino );  \r\n  SubsetElementInsert( cDimensao, cSubsetDestino, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n\r\ncDimensao\t= 'ALL.D.Versao';\r\ncElemento\t= pVersao;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetDestino , nViewTemporaria );  \r\n  ViewSubsetAssign( cCuboDestino , cViewDestino, cDimensao , cSubsetDestino );  \r\n  SubsetElementInsert( cDimensao, cSubsetDestino, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n# Cria os subsets a partir de MDX\r\n# ======================================================\r\ncDimensao\t= '';\r\ncMDX\t\t= '';\r\nIf( cDimensao @<> '');\r\n  SubsetCreatebyMDX(cSubsetDestino, cMDX, nViewTemporaria);\r\n  ViewSubsetAssign( cCuboDestino , cViewDestino, cDimensao , cSubsetDestino );  \r\n  SubsetMDXSet(cDimensao, cSubsetDestino, '');\r\nEndIf;\r\n\r\n\r\n\r\n# Configuração da View\r\n# ======================================================\r\nViewExtractSkipCalcsSet( cCuboDestino, cViewDestino, If( cSuprimirConsolidado @= 'S', 1, 0) );\r\nViewExtractSkipZeroesSet( cCuboDestino, cViewDestino, If( cSuprimirZero @= 'S', 1, 0)  );\r\nViewExtractSkipRuleValuesSet( cCuboDestino, cViewDestino, If( cSuprimirCamposCalculados @= 'S', 1, 0) );\r\n\r\n\r\n\r\n# Apaga os valores da View criada\r\n# ======================================================\r\nViewZeroOut( cCuboDestino , cViewDestino );\r\n\r\n\r\n# =================================================================================\r\n#EndRegion\r\n\r\n#Region Limpeza Cubo Rejeitados\r\n# ====================================================================================================\r\n\r\n# Definição View de Limpeza do Cudo de Rejeitados\r\n# =================================================================================\r\n\r\n# Define nome da view e subset de limpeza\r\n# ======================================================\r\ncViewRejeitado\t= 'processo.' | cProcesso | '.Rejeitados.Limpeza' | '.' | TimSt( cHorarioInicio, '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ncSubsetRejeitado\t= cViewRejeitado;\r\n\r\n\r\n\r\n# Cria a view que será utilizada para a limpeza\r\n# ======================================================\r\nViewCreate( cCuboRejeitado , cViewRejeitado , 1 );\r\n\r\n# Cria os subsets que serão utilizados para filtrar a view de limpeza\r\n# ======================================================\r\n\r\ncDimensao\t= '}Clients';\r\ncElemento\t= cUsuario;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetRejeitado , 1 );  \r\n  ViewSubsetAssign( cCuboRejeitado , cViewRejeitado, cDimensao , cSubsetRejeitado );  \r\n  SubsetElementInsert( cDimensao, cSubsetRejeitado, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n\r\ncDimensao\t= '}Processes';\r\ncElemento\t= cProcesso;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetRejeitado , 1 );  \r\n  ViewSubsetAssign( cCuboRejeitado , cViewRejeitado, cDimensao , cSubsetRejeitado );  \r\n  SubsetElementInsert( cDimensao, cSubsetRejeitado, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n# Configuração da View\r\n# ======================================================\r\nViewExtractSkipCalcsSet( cCuboRejeitado, cViewRejeitado, 1 );\r\nViewExtractSkipZeroesSet( cCuboRejeitado, cViewRejeitado, 1 );\r\nViewExtractSkipRuleValuesSet( cCuboRejeitado, cViewRejeitado, 1 );\r\n\r\n# Apaga os valores da View criada\r\n# ======================================================\r\nViewZeroOut( cCuboRejeitado, cViewRejeitado );\r\n\r\n# ====================================================================================================\r\n#EndRegion\r\n\r\n#Region View de Leitura do Cubo de Origem\r\n# =================================================================================\r\n\r\ncSuprimirConsolidado\t= 'S';\r\ncSuprimirZero\t\t= 'S'; \r\ncSuprimirCamposCalculados\t= 'N';\r\ncViewTemporaria\t \t= 'S';\r\nnViewTemporaria\t\t= If( cViewTemporaria @= 'S', 1, 0);\r\n\r\n\r\n\r\n\r\n# Define nome da view e subset de origem\r\n# ======================================================\r\ncViewOrigem\t= 'processo.' | cProcesso | '.' | 'Leitura' | '.' | TimSt( cHorarioInicio, '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ncSubsetOrigem\t= cViewOrigem;\r\n\r\n\r\n\r\n# Cria a view que será utilizada para a leitura\r\n# ======================================================\r\nViewCreate( cCuboOrigem , cViewOrigem , nViewTemporaria );\r\n\r\n\r\n\r\n# Cria os subsets que serão utilizados para filtrar a view de leitura\r\n# ======================================================\r\n\r\ncDimensao\t= 'STG.D.Ano';\r\ncElemento\t= pAno;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetOrigem, nViewTemporaria );  \r\n  ViewSubsetAssign( cCuboOrigem , cViewOrigem, cDimensao , cSubsetOrigem );  \r\n  SubsetElementInsert( cDimensao, cSubsetOrigem, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n\r\ncDimensao\t= 'STG.D.Mes';\r\ncElemento\t= pMes;\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetOrigem, nViewTemporaria );  \r\n  ViewSubsetAssign( cCuboOrigem , cViewOrigem, cDimensao , cSubsetOrigem );  \r\n  SubsetElementInsert( cDimensao, cSubsetOrigem, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n\r\ncDimensao\t= 'STG.D.Versao';\r\ncElemento\t= 'Real';\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetOrigem, nViewTemporaria );  \r\n  ViewSubsetAssign( cCuboOrigem , cViewOrigem, cDimensao , cSubsetOrigem );  \r\n  SubsetElementInsert( cDimensao, cSubsetOrigem, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\ncDimensao\t= 'STG.080.M.AgendaHub';\r\ncElemento\t= 'HdsPrevistos';\r\nIf( cDimensao @<> '');\r\n  SubsetCreate( cDimensao, cSubsetOrigem, nViewTemporaria );  \r\n  ViewSubsetAssign( cCuboOrigem , cViewOrigem, cDimensao , cSubsetOrigem );  \r\n  SubsetElementInsert( cDimensao, cSubsetOrigem, cElemento\t, 1 );\r\nEndIf;\r\n\r\n\r\n# Cria os subsets a partir de MDX\r\n# ======================================================\r\ncDimensao\t= '';\r\ncMDX\t\t= '';\r\nIf( cDimensao @<> '');\r\n  SubsetCreatebyMDX(cSubsetOrigem, cMDX, nViewTemporaria);\r\n  ViewSubsetAssign( cCuboOrigem , cViewOrigem, cDimensao , cSubsetOrigem );  \r\n  SubsetMDXSet(cDimensao, cSubsetOrigem, '');\r\nEndIf;\r\n\r\n\r\n\r\n# Configuração da View de Leitura\r\n# ======================================================\r\nViewExtractSkipCalcsSet( cCuboOrigem, cViewOrigem, If( cSuprimirConsolidado @= 'S', 1, 0) );\r\nViewExtractSkipZeroesSet( cCuboOrigem, cViewOrigem, If( cSuprimirZero @= 'S', 1, 0)  );\r\nViewExtractSkipRuleValuesSet( cCuboOrigem, cViewOrigem, If( cSuprimirCamposCalculados @= 'S', 1, 0) );\r\n\r\n\r\n\r\n# Define Cubo de Origem como Datasource\r\n# ==================================\r\nDataSourceCubeView = cViewOrigem;\r\n\r\n#EndRegion\r\n\r\nIF(pVersao@='Real');\r\n  sAno = pAno ;\r\n  sMes = pMes;\r\nelse;\r\n  IF(pMes@='01');\r\n    sAno =  NumberToString( StringToNumber(pAno) - 1);\r\n    sMes = '12' ;\r\n  else;\r\n    sAno = pAno;\r\n    sMes = IF(pMes@<='10','0','')| NumberToString( StringToNumber(pMes) - 1);\r\n  endIF;\r\nendIF;\r\n\r\n#endregion\r\n#region Data\r\n\r\n# ===============================================================================================================\r\n#DATACOMMENT        Descrição:  Grava dados no cubo acumulando valores.\r\n# ===============================================================================================================\r\n\r\n# ===================================================================================\r\n# Gera contador para o arquivo de debug ou registros rejeitados o e quantid. total de registros processados\r\n# ===================================================================================\r\ncContadorRegistro = cContadorRegistro + 1;\r\nsContadorRegistro = NumberToString( cContadorRegistro );\r\n\r\n\r\n\r\n# ===================================================================================\r\n# Marca o registro para rejeitar \r\n# Caso a variavel estiver em branco, se não existir na dimensão ou se for um totalizador\r\n# ===================================================================================\r\n\r\nvFrente = IF(vFrente@='@STG.D.Frente','@ALL.D.Frentes',vFrente);\r\nsDim\t= 'ALL.D.Frentes';\r\nsElm\t= vFrente;\r\nsCol\t= 'Frente';\r\n\r\nIf( cExisteRegistroRejeitado = 0 );\r\n   If( DimIx( sDim , sElm ) = 0 );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    contêm o valor:    [ ' | sElm | ' ]    que não existe na dimensão:    [ ' | sDim | ' ]';\r\n      cExisteRegistroRejeitado = 1;\r\n   ElseIf( dType( sDim , sElm ) @= 'C' );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    contêm o valor:    [ ' | sElm | ' ]    que é um totalizador na dimensão:    [ ' | sDim | ' ]    totalizadores não podem receber carga';\r\n      cExisteRegistroRejeitado = 1;\r\n   EndIf;\r\nEndIf;\r\n\r\n# ===================================================================================\r\n# Marca o registro para rejeitar \r\n# Caso a variavel estiver em branco, se não existir na dimensão ou se for um totalizador\r\n# ===================================================================================\r\n\r\nvPessoa = IF(vPessoa@='STG.D.Pessoa','@ALL.D.Pessoas',vPessoa) ;\r\nsDim\t= 'ALL.D.Pessoas';\r\nsElm\t= vPessoa;\r\nsCol\t= 'Pessoa';\r\n\r\nIf( cExisteRegistroRejeitado = 0 );\r\n   If( DimIx( sDim , sElm ) = 0 );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    contêm o valor:    [ ' | sElm | ' ]    que não existe na dimensão:    [ ' | sDim | ' ]';\r\n      cExisteRegistroRejeitado = 1;\r\n   ElseIf( dType( sDim , sElm ) @= 'C' );\r\n      cMensagemRegistro = 'A coluna    [ ' | sCol | ' ]    contêm o valor:    [ ' | sElm | ' ]    que é um totalizador na dimensão:    [ ' | sDim | ' ]    totalizadores não podem receber carga';\r\n      cExisteRegistroRejeitado = 1;\r\n   EndIf;\r\nEndIf;\r\n\r\n# ===================================================================================\r\n# DEBUG ou REJEIÇÃO\r\n# Registra em arquivo os registros\r\n# ===================================================================================\r\nIf( cExisteRegistroRejeitado = 1  %  cUtilizarDebug @= 'S' );\r\n# Escreve o registro no arquivo de debug ou rejeitados\r\n# =================================================================================\r\n  cQtdRegistroRejeitado = cQtdRegistroRejeitado + 1;\r\n  if(cQtdRegistroRejeitado<1000);  \r\n    sLine = 'Line' | Fill( '0' , 3 - Long(NumberToString( cQtdRegistroRejeitado ))) | NumberToString( cQtdRegistroRejeitado ) ;\r\n    CellPutS( sContadorRegistro, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Num. Registro' );\r\n    CellPutS( cMensagemRegistro, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Mensagem de Erro' );\r\n      \r\n    CellPutS( vAno, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col01' );\r\n    CellPutS( vMes, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col02' );\r\n    CellPutS( vVersao, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col03' );\r\n    CellPutS( vItem, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col04' );\r\n    CellPutS( vFrente, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col05' );\r\n    CellPutS( vPessoa, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col06' );\r\n    CellPutS( vMetrica, cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col07' );\r\n    CellPutS( NumberToString( vValor ), cCuboRejeitado, cUsuario, cProcesso, sLine, 'Col08' );\r\n  endIF;  \r\n\r\n  # Limpa as variaveis e pula o registro\r\n  # ============================\r\n  IF( cExisteRegistroRejeitado = 1 );\r\n     cTipoErro = 2;\r\n     cExisteRegistroRejeitado = 0;\r\n     cMensagemRegistro = '';\r\n     cMensagemProcesso = ' Processo concluido com rejeitados, verificar o cubo:    ' | cCuboRejeitado;\r\n     ItemSkip;\r\n  EndIf;\r\nEndIf;\r\n\r\n# ====================================================================================================\r\n#EndRegion\r\nvPessoaOri = vPessoa;\r\nsPessoa = vPessoa;\r\nsHier = 'STG.D.Pessoa';\r\nif(pVersao@<>'Real');\r\n  sPessoa = CellGetS('MAP.050.Pessoas', vPessoa, 'funcao' );\r\n    sHier = 'Funcao';\r\n  if(Dimix('STG.D.Pessoa:Funcao',sPessoa)=0);\r\n      ItemSkip;\r\n  endIF;\r\nendiF;\r\nvCusto = CellGetN( 'STG.070.CustoPessoal'\r\n         , sAno\r\n         , sMes\r\n         , vVersao\r\n         , 'ALL.D.LineItem':'Total Item com Ajuste'\r\n         , 'STG.D.Coligada':'Total STG.D.Coligada'\r\n         , 'Pacote':'Pessoal'\r\n         , 'STG.D.CentroCustos':'Total STG.D.CentroCustos'\r\n         ,sHier:sPessoa\r\n         ,'STG.D.Moeda':'Total STG.D.Moeda', 'saldo_final' ) ;\r\n\r\nIF(vCusto=0);\r\n    if(pVersao@='Real');\r\n        if(DIMIX('ALL.D.Pessoas','HUB_'| CellGEtS(cCuboOrigem, vAno, vMes, vVersao, vItem, vFrente, vPessoa, 'codigo_funcionario_hub' ))=0);\r\n            ItemSkip;\r\n        endIF;\r\n        sPessoa = DimensionElementPrincipalName( 'ALL.D.Pessoas', 'HUB_' | CellGEtS(cCuboOrigem, vAno, vMes, vVersao, vItem, vFrente, vPessoa, 'codigo_funcionario_hub' ) );\r\n        if(dimix('ALL.D.Pessoas',sPessoa)=0);\r\n            ItemSkip;\r\n        endIF;\r\n        vCusto = CellGetN( 'STG.070.CustoPessoal'\r\n         , sAno\r\n         , sMes\r\n         , vVersao\r\n         , 'ALL.D.LineItem':'Total Item com Ajuste'\r\n         , 'STG.D.Coligada':'Total STG.D.Coligada'\r\n         , 'Pacote':'Pessoal'\r\n         , 'STG.D.CentroCustos':'Total STG.D.CentroCustos'\r\n         ,sHier:sPessoa\r\n         ,'STG.D.Moeda':'Total STG.D.Moeda', 'saldo_final' ) ;\r\n        if(vCusto=0);\r\n           ItemSkip;\r\n        endIF;\r\n        vPessoa = sPessoa;\r\n    else;\r\n      ItemSkip;\r\n    endIF;\r\nEndIF;\r\n\r\n# ===================================================================================\r\n# Grava os dados no cubo\r\n# ===================================================================================\r\n\r\n\r\ns01 = vAno ;\r\ns02 = vMes ;\r\ns03 = pVersao ;\r\ns06 = vFrente ;\r\ns07 = vPessoa ;\r\n#s06 = vTipoFrente ;\r\n\r\n\r\nIF(CellGetN(cCuboDestino, s01, s02, s03, 'ALL.D.Moeda':'Total Moeda', 'ALL.D.Empresas':'Total Empresas', s06, s07,'@TipoHD', 'Custo Total' )<>0);\r\n  CellPutProportionalSpread( 0, cCuboDestino, s01, s02, s03, 'ALL.D.Moeda':'Total Moeda', 'ALL.D.Empresas':'Total Empresas', s06, s07,'@TipoHD', 'Custo Total' );\r\nEndIF;\r\n\r\nIF(SubsetExists( 'STG.D.Coligada', cProcesso| 'Empresa' | sPessoa )=0);\r\n  mdxEmpresa = '{FILTER({Tm1FilterByLevel({Tm1SubsetAll([STG.D.Coligada].[STG.D.Coligada])},0)},\r\n                             [STG.070.CustoPessoal].(\r\n                                [STG.D.Ano].[STG.D.Ano].['|sAno|'],\r\n                                [STG.D.Mes].[STG.D.Mes].['|sMes|'],\r\n                                [STG.D.Versao].[STG.D.Versao].[Real],\r\n                                [ALL.D.LineItem].[ALL.D.LineItem].[Total Item com Ajuste],\r\n                                [STG.D.ContaContabil].[Pacote].[Pessoal],\r\n                                [STG.D.CentroCustos].[STG.D.CentroCustos].[Total STG.D.CentroCustos],\r\n                                [STG.D.Pessoa].['|sHier|'].['|sPessoa|'],\r\n                                [STG.D.Moeda].[STG.D.Moeda].[Total STG.D.Moeda],\r\n                                [STG.070.M.CustoPessoal].[STG.070.M.CustoPessoal].[saldo_final]                              \r\n                              )<>0)}';\r\n  \r\n  SubsetCreatebyMDX(cProcesso| 'Empresa' | sPessoa, mdxEmpresa, 1);\r\n  SubsetMDXSet('STG.D.Coligada', cProcesso| 'Empresa' | sPessoa, '');\r\nEndIf;\r\ncontEmpresa = 1;\r\nsizEmpresa = SubsetGetSize( 'STG.D.Coligada', cProcesso| 'Empresa' | sPessoa );\r\nwhile(contEmpresa<=sizEmpresa);\r\n  vColigada  = SubsetGetElementName( 'STG.D.Coligada', cProcesso| 'Empresa' | sPessoa, contEmpresa );\r\n  vEmpresa = CellGetS( 'PRE.080.ColigadaEmpresa', vColigada, 'Empresa' );\r\n\r\n  IF(SubsetExists( 'STG.D.Moeda', cProcesso| 'Moeda' | sPessoa | '_' | vColigada )=0);\r\n    mdxMoeda = '{FILTER({Tm1FilterByLevel({Tm1SubsetAll([STG.D.Moeda].[STG.D.Moeda])},0)},\r\n                               [STG.070.CustoPessoal].(\r\n                                  [STG.D.Ano].[STG.D.Ano].['|sAno|'],\r\n                                  [STG.D.Mes].[STG.D.Mes].['|sMes|'],\r\n                                  [STG.D.Versao].[STG.D.Versao].[Real],\r\n                                  [ALL.D.LineItem].[ALL.D.LineItem].[Total Item com Ajuste],\r\n                                  [STG.D.Coligada].[STG.D.Coligada].['| vColigada|'],\r\n                                  [STG.D.ContaContabil].[Pacote].[Pessoal],\r\n                                  [STG.D.CentroCustos].[STG.D.CentroCustos].[Total STG.D.CentroCustos],\r\n                                  [STG.D.Pessoa].['|sHier|'].['|sPessoa|'],\r\n                                  [STG.070.M.CustoPessoal].[STG.070.M.CustoPessoal].[saldo_final]                              \r\n                                )<>0)}';\r\n    \r\n    SubsetCreatebyMDX(cProcesso| 'Moeda' | sPessoa | '_' | vColigada, mdxMoeda, 1);\r\n    SubsetMDXSet('STG.D.Moeda', cProcesso| 'Moeda' | sPessoa | '_' | vColigada, '');\r\n  EndIf;\r\n  contMoeda = 1;\r\n  sizMoeda = SubsetGetSize( 'STG.D.Moeda', cProcesso| 'Moeda' | sPessoa | '_' | vColigada );\r\n  while(contMoeda<=sizMoeda);\r\n    vMoeda  = SubsetGetElementName( 'STG.D.Moeda', cProcesso| 'Moeda' | sPessoa | '_' | vColigada, contMoeda );\r\n\r\n    IF(SubsetExists( 'STG.D.CentroCustos', cProcesso| 'CentroCustos' | sPessoa | '_' | vColigada| '_' | vMoeda )=0);\r\n      mdxCC = '{FILTER({Tm1FilterByLevel({Tm1SubsetAll([STG.D.CentroCustos].[STG.D.CentroCustos])},0)},\r\n                                 [STG.070.CustoPessoal].(\r\n                                    [STG.D.Ano].[STG.D.Ano].['|sAno|'],\r\n                                    [STG.D.Mes].[STG.D.Mes].['|sMes|'],\r\n                                    [STG.D.Versao].[STG.D.Versao].[Real],\r\n                                    [ALL.D.LineItem].[ALL.D.LineItem].[Total Item com Ajuste],\r\n                                    [STG.D.Coligada].[STG.D.Coligada].['| vColigada|'],\r\n                                    [STG.D.ContaContabil].[Pacote].[Pessoal],\r\n                                    [STG.D.Pessoa].['|sHier|'].['|sPessoa|'],\r\n                                    [STG.D.Moeda].[STG.D.Moeda].['|vMoeda|'],\r\n                                    [STG.070.M.CustoPessoal].[STG.070.M.CustoPessoal].[saldo_final]                              \r\n                                  )<>0)}';\r\n      \r\n      SubsetCreatebyMDX(cProcesso| 'CentroCustos' | sPessoa | '_' | vColigada| '_' | vMoeda, mdxCC, 1);\r\n      SubsetMDXSet('STG.D.CentroCustos', cProcesso| 'CentroCustos' | sPessoa | '_' | vColigada| '_' | vMoeda, '');\r\n    EndIf;\r\n    contCC = 1;\r\n    sizCC = SubsetGetSize( 'STG.D.CentroCustos', cProcesso| 'CentroCustos' | sPessoa | '_' | vColigada| '_' | vMoeda );\r\n    \r\n      s04 = vMoeda;\r\n      s05 = vEmpresa;\r\n      CellPutS( vEmpresa, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Empresa' );\r\n      CellPutS( vEmpresa, cCuboDestino, s01, s02, s03, s04, s05, '@ALL.D.Frentes', s07, '@TipoHD', 'Empresa' );\r\n      \r\n      #Pais\r\n      vPais = CellGetS('MAP.060.Empresas', vEmpresa, 'País' );\r\n      CellPutS( vPais, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Pais' );\r\n      CellPutS( vPais, cCuboDestino, s01, s02, s03, s04, s05,  '@ALL.D.Frentes', s07, '@TipoHD', 'Pais' );\r\n      \r\n      #Moeda\r\n      #vMoeda = CellGetS('MAP.060.Empresas', vEmpresa, 'Moeda Funcional' );\r\n      CellPutS( vMoeda, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Moeda' );\r\n      CellPutS( vMoeda, cCuboDestino, s01, s02, s03, s04, s05,  '@ALL.D.Frentes', s07, '@TipoHD', 'Moeda' );\r\n      \r\n      #Carteira\r\n      vCarteira = CellGetS( 'MAP.030.Frentes', vFrente, 'Carteira' );\r\n      CellPutS( vCarteira, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Carteira' );\r\n      \r\n      #CarteiraCross\r\n      vCarteiraCross = CellGetS( 'MAP.030.Frentes', vFrente, 'Carteira Cross' );\r\n      CellPutS( vCarteiraCross, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Carteira_Cross' );\r\n      \r\n      #Cargo\r\n      vTipoAgenda = CellGetS( 'STG.080.AgendaHub', s01, s02, 'Real', vItem, vFrente, vPessoaOri, 'tipoagenda' );\r\n      vNomeFuncao = CellGetS( 'MAP.050.Pessoas', vPessoa, 'funcao' );\r\n      vTipoHd = CellGetS( 'PRE.070.TipoHD', vTipoAgenda, 'TipoHD' ) ;\r\n      IF(vTipoHD@='Projeto' & Dimix('MAP.D.Frentes',vFrente)<>0);\r\n         vTipo = CellGEtS('MAP.030.Frentes', vFrente, 'Tipo da Frente' );\r\n          vTipoHd = IF(vTipo@='Venda', 'Vendas', IF(vTipo@='Interno', 'Projeto Interno', 'Projeto'));\r\n      EndIF;\r\n      CellPutS( vNomeFuncao, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Cargo' );\r\n      CellPutS( vNomeFuncao, cCuboDestino, s01, s02, s03, s04, s05, '@ALL.D.Frentes', s07, '@TipoHD', 'Cargo' );\r\n      \r\n      #TipoFrente\r\n      vTipoFrente = CellGetS( 'MAP.030.Frentes', vFrente, 'Tipo da Frente' );\r\n      CellPutS( vTipoFrente, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Tipo de  Frente' );\r\n      vTipoFrente = IF(vTipoFrente@='','Projeto',vTipoFrente) ;\r\n      \r\n      #DiasUteis\r\n      vDiasUteis = CellGetN('ALL.010.PremissasPais', s01, s02, 'Real', vPais, 'Dias Úteis' );\r\n      CellPutN( vDiasUteis, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'Dias Úteis' );\r\n      CellPutN( vDiasUteis, cCuboDestino, s01, s02, s03, s04, s05, '@ALL.D.Frentes', s07, '@TipoHD', 'Dias Úteis' );\r\n      \r\n      #HdsPrevistos\r\n      CellIncrementN( vValor, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, vTipoHd, 'HdsPrevistos');\r\n      CellIncrementN( vValor, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, vTipoHd, 'HD');\r\n      \r\n      #HdsPrevistos\r\n      nHdCad = CellGetN(cCuboOrigem, vAno,vMes, vVersao, vItem, vFrente, vPessoaOri, 'HdsCadastrados' ) ;\r\n      CellIncrementN( nHdCad, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, vTipoHd, 'HdsCadastrados');\r\n      \r\n      \r\n    while(contCC<=sizCC);\r\n      vCC  = SubsetGetElementName( 'STG.D.CentroCustos', cProcesso| 'CentroCustos' | sPessoa | '_' | vColigada| '_' | vMoeda, contCC );\r\n      #Empresa\r\n      #vEmpresa = CellGetS( 'MAP.030.Frentes', vFrente, 'Empresa' );\r\n      vEmpresa = if(vEmpresa@='','121',vEmpresa);\r\n  \r\n      #CC\r\n      #vCC = CellGetS( 'MAP.030.Frentes', vFrente, 'Centro de Custo Frente' );\r\n      CellPutS( vCC, cCuboDestino, s01, s02, s03, s04, s05, s06, s07, '@TipoHD', 'CC' );\r\n      CellPutS( vCC, cCuboDestino, s01, s02, s03, s04, s05,  '@ALL.D.Frentes', s07, '@TipoHD', 'CC' );\r\n      \r\n      #CustoTotal\r\n      vCustoTotal = \r\n        CellGetN( 'STG.070.CustoPessoal', sAno, sMes, 'Real', 'ALL.D.LineItem':'Total Item com Ajuste', vColigada, 'Pacote':'Pessoal', vCC, sHier:sPessoa, vMoeda, 'saldo_final' ) \r\n        \\\r\n        CellGetN( 'STG.070.CustoPessoal', sAno, sMes, 'Real', '@ALL.D.LineItem', '@STG.D.Coligada', '@STG.D.ContaContabil', '@STG.D.CentroCustos', sHier:sPessoa, '@STG.D.Moeda', 'qtd_pessoas' ) ;\r\n      if(pVersao@<>'Real');\r\n        nTotal = vCustoTotal;\r\n        nMinimo = nTotal;\r\n        nMaximo = nTotal;\r\n        nMes = StringToNumber(sMes);\r\n        nAno = StringToNumber(sAno);\r\n        i = 1;\r\n        j = 1;\r\n        while( i <= 5);\r\n          i = i +1;\r\n          niMes = MOD(12 + (nMes -i) -1  ,12) + 1;\r\n          niAno = nAno - IF(niMes>nMes,1,0);\r\n          niTotal =\r\n              CellGetN('STG.070.CustoPessoal', NumberToString(niAno), NumberToString( niMes ), 'Real', 'ALL.D.LineItem':'Total Item com Ajuste', vColigada, 'Pacote':'Pessoal', vCC, sHier:sPessoa, vMoeda, 'saldo_final' )\r\n              \\\r\n              CellGetN( 'STG.070.CustoPessoal', NumberToString(niAno), NumberToString( niMes ), 'Real', '@ALL.D.LineItem', '@STG.D.Coligada', '@STG.D.ContaContabil', '@STG.D.CentroCustos', sHier:sPessoa, '@STG.D.Moeda', 'qtd_pessoas' ) ;\r\n          if(niTotal<>0);\r\n            j = j+1;\r\n            nMinimo = IF(niTotal<nMinimo,niTotal, nMinimo);\r\n            nMaximo = IF(niTotal>nMaximo,niTotal, nMaximo);\r\n            nTotal = nTotal + niTotal;\r\n          endIF;\r\n        end;\r\n        if(j<3);\r\n          vCustoTotal = nTotal / j;\r\n        else;\r\n          vCustoTotal = (nTotal - nMinimo - nMaximo)/(j-2);\r\n        endIF;\r\n      endIF;\r\n      CellIncrementN( vCustoTotal, cCuboDestino, s01, s02, s03, s04, s05, s06, s07,'@TipoHD', 'Custo Total' );\r\n      #CellIncrementN( vCustoTotal, cCuboDestino, s01, s02, s03, s04, s05, '@ALL.D.Frentes', s07,'@TipoHD', 'Custo Total' );\r\n      contCC = contCC + 1;\r\n    end;\r\n    contMoeda = contMoeda + 1;\r\n  end;\r\n  contEmpresa = contEmpresa + 1;\r\nend;\r\n\r\n\r\n\r\n\r\n\r\n\r\n#endregion\r\n#region Epilog\r\n\r\n# ===============================================================================================================\r\n#EPILOGCOMMENT        Descrição:  Habilita log do cubo de destino, realiza CubeSaveData e registra log de status do processo.\r\n# ===============================================================================================================\r\n\r\n# =================================================================================\r\n# Habilita o Log e salva dados no cubo\r\n# ================================================================================= \r\n\r\n# =================================================================================\r\n# Registra o Log de Erro ou Sucesso no Cubo de Controle\r\n# =================================================================================\r\nIf( cTipoErro = 0 );\r\n   cMensagemProcesso  = ' Processo concluído com sucesso';\r\nEndIf;\r\n\r\n\r\ns01\t= TimSt( cHorarioInicio , '\\Y-\\m-\\d \\hh\\im\\ss' );\r\ns02 \t= cUsuario ;\r\ns03 \t= cMensagemProcesso ;\r\ns04 \t= sContadorRegistro  ;\r\ns05 \t= TimSt( Now - cHorarioInicio, ' \\h:\\i:\\s') ;\r\n\r\nCellPutS( s01 , cCuboParametro, cProcesso, 'DataHora Fim' );\r\nCellPutS( s02 , cCuboParametro, cProcesso, 'Usuário' );\r\nCellPutS( s03 , cCuboParametro, cProcesso, 'Mensagem de Log' );\r\nCellPutS( s04 , cCuboParametro, cProcesso, 'Registros Processados' );\r\nCellPutS( s05 , cCuboParametro, cProcesso, 'Tempo de Execução' );\r\n\r\n\r\nIf( cTipoErro = 2 );\r\n  ItemReject( cMensagemProcesso );\r\nEndIf;\r\n\r\n#endregion",
	"DataSource":
	{
		"Type":"TM1CubeView",
		"dataSourceNameForServer":"STG.080.AgendaHub",
		"dataSourceNameForClient":"STG.080.AgendaHub",
		"view":"SYS_Unitaria"
	},
	"Parameters":
	[
		{
			"Name":"pAno",
			"Prompt":"",
			"Value":"2025",
			"Type":"String"
		},
		{
			"Name":"pMes",
			"Prompt":"",
			"Value":"05",
			"Type":"String"
		},
		{
			"Name":"pVersao",
			"Prompt":"",
			"Value":"Real",
			"Type":"String"
		}
	],
	"Variables":
	[
		{
			"Name":"vAno",
			"Type":"String",
			"Position":1,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vMes",
			"Type":"String",
			"Position":2,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vVersao",
			"Type":"String",
			"Position":3,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vItem",
			"Type":"String",
			"Position":4,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vFrente",
			"Type":"String",
			"Position":5,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vPessoa",
			"Type":"String",
			"Position":6,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vMetrica",
			"Type":"String",
			"Position":7,
			"StartByte":0,
			"EndByte":0
		},
		{
			"Name":"vValor",
			"Type":"Numeric",
			"Position":8,
			"StartByte":0,
			"EndByte":0
		}
	],
	"UID": "1748890713000",
	"UIData": "_ParameterConstraints=e30=\f",
	"VariablesUIData": [
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=32\fColType=827\f",
		"VarType=33\fColType=827\f"
	]
}